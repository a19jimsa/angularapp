#version 300 es
precision mediump float;

uniform sampler2D u_texture;
uniform sampler2D u_flowMap;
uniform float u_time;
uniform float u_tiling;
uniform float u_flowSpeed;
uniform float u_animationSpeed;
uniform vec3 u_cameraPos;

in vec2 v_texcoord;
in vec3 v_normal;
in vec3 v_fragPos;


struct Material{
   vec3 ambient;
   vec3 diffuse;
   vec3 specular;
   float shininess;
};

uniform Material material;

struct Light{
   vec3 position;
   vec3 ambient;
   vec3 diffuse;
   vec3 specular;
};

uniform Light light;

out vec4 FragColor;

void main() {
   // --- Flow + UVs ---
   vec2 flow = texture(u_flowMap, v_texcoord).rg; // 0–1
   flow = flow * 2.0 - 1.0;

   vec2 tileSize = vec2(1.0 / 3.0, 1.0); 
   vec2 uv_normal1 = fract(v_texcoord * tileSize * u_tiling) + vec2(0.0, -1.0) * u_time * 0.01 * (tileSize) + vec2(0.0, 0.0) * tileSize;
   vec2 uv_normal2 = fract(v_texcoord * tileSize * u_tiling) + vec2(0.0, 0.0) * tileSize;
   vec2 uv_foam = fract(v_texcoord * u_tiling + flow * u_time) * tileSize + vec2(2.0, 0.0) * tileSize;

   // Hämta normals
   vec3 normal1 = texture(u_texture, uv_normal1).rgb * 2.0 - 1.0;
   vec3 normal2 = texture(u_texture, uv_normal2).rgb * 2.0 - 1.0;

   // Blenda
   vec3 blendedNormal = normalize(mix(normal1, normal2, 0.5));

   // --- Light calculations ---
   vec3 lightDir = normalize(light.position - v_fragPos);
   float NdotL = max(dot(blendedNormal, lightDir), 0.0);

   // --- View / specular ---
   vec3 viewDir = normalize(u_cameraPos - v_fragPos);
   vec3 reflectDir = reflect(-lightDir, blendedNormal);  
   float spec = pow(max(dot(viewDir, reflectDir), 0.0), material.shininess);

   // --- Base water colors ---
   vec3 deepWaterColor = material.ambient;
   vec3 shallowWaterColor = light.ambient;

   // --- Diffuse lighting (vattnets basfärg med ljus) ---
   vec3 lightFactor = vec3(NdotL); // intensitet från ljuset
   vec3 baseColor = mix(deepWaterColor, shallowWaterColor, 0.5); // jämn blå bas
   vec3 diffuse = baseColor * lightFactor;

   // --- Specular highlight (glans) ---
   vec3 specularColor = vec3(1.0) * spec;

   // --- Kombinera ---
   vec3 finalColor = diffuse + specularColor;

   // --- Alpha/transparens ---
   float alpha = 0.7; // genomskinligt blått vatten

   FragColor = vec4(finalColor, alpha);

}