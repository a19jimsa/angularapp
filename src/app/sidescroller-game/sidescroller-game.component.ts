import {
  AfterContentInit,
  Component,
  ElementRef,
  ViewChild,
} from '@angular/core';
import { CanvasDisplay } from './models/canvas-display.model';
import { Level } from './models/level.model';
import { State } from './models/state.model';

@Component({
  selector: 'app-sidescroller-game',
  templateUrl: './sidescroller-game.component.html',
  styleUrls: ['./sidescroller-game.component.css'],
  standalone: false,
})
export class SidescrollerGameComponent implements AfterContentInit {
  private GAME_LEVELS = [
    `                                                    
########################
#......................#
#......................#
#......................#
#.........p............#
#......................#
#......................#
#......................#
#......................#
#................o.....#
#......................#
########################
`,
    `                                                    
................................................................................
..#.............................................................................
..#.....#.......................................................................
..#.....#.......................................................................
..##....#..........................................................p............
..#.....#.......................................................................
..#.....#.........................................................###...........
..#....##..........................................##......##....##+##..........
..#.....#...........................o.o......##..................#+++#..........
..#.....#........................................................##+##..........
..#.....#..........................#####..........................#v#...........
..#.....##..................................................................##..
..##....#.................................o.o................................#..
..#.....#....................................................................#..
..#.....#................................#####.............................o.#..
..#.....#....####............................................................#..
..#.....#....#..#................................................#####.......#..
..############..###############...####################.....#######...#########..
..............................#...#..................#.....#....................
..............................#+++#..................#+++++#....................
..............................#+++#..................#+++++#....................
..............................#####..................#######....................
................................................................................
................................................................................
`,
    `                                                                     
................................................................................
................................................................................
....###############################.............................................
...##.............................##########################################....
...#.......................................................................##...
...#....o...................................................................#...
...#.........................E......................=.......................#...
...#.o........################...................o..o...........|........o..#...
...#.........................#.............................................E#...
...#....o....................###########....###################....##########...
...#..................................##++++#.................#....#............
...###############....oo......=o.o....#######.###############.#....#............
.....#...............o..o.............#.......#......#........#....#............
.....#...................E#############..######.####.#.########....########.....
.....#.............########..............#...........#.#..................#.....
.....#..........####......####...#####################.#..................#.....
.....#........###............###.......................########....########.....
.....#.......##................#########################......#....#............
.....#.......#................................................#....#............
.....###......................................................#....#............
.......#...............o...........................................#............
.......#...............................................o...........#............
.......##########.....###.....############..............E..........##...........
.............#..................#........#####....#######.o.........########....
.............#++++++++++++++++++#............#....#.....#..................#....
.............#++++++++++++++++++#..........###....###...####.o.............#....
.............####################..........#........#......#.....|.........#....
...........................................#++++++++#......####............#....
...........................................#++++++++#.........#.....E..@...#....
...........................................#++++++++#.........##############....
...........................................##########...........................
................................................................................
`,
    `
......................................#++#........................#######....................................#+#..
......................................#++#E....................####.....####.................................#+#..
......................................#++##########...........##...........##................................#+#..
......................................##++++++++++##.........##.............##...............................#+#..
.......................................##########++#.........#....................................o...o...o..#+#..
................................................##+#.........#.....o...o....................................##+#..
.................................................#+#.........#................................###############++#..
.................................................#v#.........#.....#...#........................++++++++++++++##..
.............................................................##..|...|...|..##............#####################...
..............................................................##+++++++++++##............v........................
...............................................................####+++++####......................................
...............................................#.....#............#######........###.........###..................
...............................................#.....#...........................#.#.........#.#..................
...............................................#.....#.............................#.........#....................
...............................................#.....#.............................##........#....................
...............................................##....#.............................#.........#....................
...............................................#.....#......o..o.....#...#.........#.........#....................
...............#######........###...###........#.....#...............#...#.........#.........#....................
..............##.....##.........#...#..........#.....#.....######....#...#...#########.......#....................
.............##.......##........#.o.#..........#....##...............#...#...#...............#....................
.....@.......#.........#........#...#..........#.....#...............#...#...#...............#....................
....###......#.........#........#...#..........#.....#...............#...#####...######......#....................
....#.#......#.........#.......##.o.##.........#.....#...............#.....o.....#.#.........#....................
++++#.#++++++#.........#++++++##.....##++++++++##....#++++++++++.....#E....=.....#.#.........#....................
++++#.#++++++#.........#+++++##.......##########.....#+++++++##+.....#############.##..o.o..##....................
++++#.#++++++#.........#+++++#....o.................##++++++##.+....................##.....##.....................
++++#.#++++++#.........#+++++#E....................##++++++##..+.....................#######......................
++++#.#++++++#.........#+++++##.......##############++++++##...+..................................................
++++#.#++++++#.........#++++++#########++++++++++++++++++##....+..................................................
++++#.#++++++#.........#++++++++++++++++++++++++++++++++##.....+..................................................
`,
    `
..............................................................................................................
..............................................................................................................
..............................................................................................................
..............................................................................................................
..............................................................................................................
........................................o.....................................................................
..............................................................................................................
........................................#.....................................................................
........................................#.....................................................................
........................................#.....................................................................
........................................#.....................................................................
.......................................###....................................................................
.......................................#.#.................+++........+++..###................................
.......................................#.#.................+#+........+#+.....................................
.....................................###.###................#..........#......................................
......................................#...#.................#...oooo...#.......###............................
......................................#...#.................#..........#......#+++#...........................
......................................#...#.................############.......###............................
.....................................##...##......#...#......#................................................
......................................#...#########...########..............#.#...............................
......................................#...#...........#....................#+++#..............................
......................................#...#...........#.....................###...............................
.....................................##...##..........#.......................................................
......................................#...#=.=.=.=....#............###........................................
......................................#...#...........#...........#+++#.......................................
......................................#...#....=.=.=.=#.....o......###.......###..............................
.....................................##...##..........#.....................#+++#.............................
..............................o...o...#...#...........#.....#................##v........###...................
......................................#...#...........#..............#.................#+++#..................
.............................###.###.###.###.....o.o..#++++++++++++++#...................v#...................
.............................#.###.#.#.###.#..........#++++++++++++++#........................................
.............................#.............#...#######################........................................
.............................##...........##.........................................###......................
..###.........................#.....#.....#.........................................#+++#................###..
..#.#.........................#....###....#..........................................###.................#.#..
..#...........................#....###....#######........................#####.............................#..
..#...........................#...........#..............................#...#.............................#..
..#...........................##..........#..............................#.#.#.............................#..
..#.......................................#.......|####|....|####|.....###.###.............................#..
..#................###.............o.o....#..............................#.........###.....................#..
..#...............#####.......##..........#.............................###.......#+++#..........#.........#..
..#...............o###o.......#....###....#.............................#.#........###..........###........#..
..#................###........#############..#.oo.#....#.oo.#....#.oo..##.##....................###........#..
..#E.....@..........#.........#...........#++#....#++++#....#++++#....##...##....................#........E#..
..#############################...........#############################.....################################..
..............................................................................................................
..............................................................................................................
`,
    `
..................................................................................................###.#.......
......................................................................................................#.......
..................................................................................................#####.......
..................................................................................................#...........
..................................................................................................#.###.......
..........................o.......................................................................#.#.#.......
.............................................................................................o.o.o###.#.......
...................###....................................................................E...........#.......
.......+..o..+................................................#####.#####.#####.#####.#####.#####.#####.......
.......#.....#................................................#...#.#...#.#...#.#...#.#...#.#...#.#...........
.......#=.o..#............#...................................###.#.###.#.###.#.###.#.###.#.###.#.#####.......
.......#.....#..................................................#.#...#.#...#.#...#.#...#.#...#.#.....#.......
.......+..o..+............o..................................####.#####.#####.#####.#####.#####.#######.......
..............................................................................................................
..........o..............###..............................##..................................................
..............................................................................................................
..............................................................................................................
......................................................##......................................................
...................###.........###............................................................................
..............................................................................................................
..........................o.....................................................#......#......................
..........................................................##.....##...........................................
.............###.........###.........###.................................#..................#.................
..............................................................................................................
.................................................................||...........................................
..###########.................................................................................................
..#.........#.o.#########.o.#########.o.##................................................#...................
..#.........#...#.......#...#.......#...#.................||..................#.....#.........................
..#..@......#####...o...#####...o...#####.....................................................................
..#######.....................................#####.......##.....##.....###...................................
........#=..................=................=#...#....................E###...................................
........#######################################...#+++++++++++++++++++++###+++++++++++++++++++++++++++++++++++
..................................................############################################################
..............................................................................................................
`,
  ];

  @ViewChild('canvas', { static: true }) canvas!: ElementRef<HTMLCanvasElement>;

  private CanvasDisplay!: CanvasDisplay;
  private level!: Level;
  private loopId = 0;

  ngAfterContentInit(): void {
    this.level = new Level(this.GAME_LEVELS[0]);
    this.CanvasDisplay = new CanvasDisplay(this.canvas, this.level);
    //setTimeout(() => this.runGame(this.GAME_LEVELS, this.CanvasDisplay), 3000);
  }

  ngDestroy() {}

  trackKeys(keys: any) {
    let down = Object.create(null);
    function track(event: any) {
      if (keys.includes(event.key)) {
        down[event.key] = event.type === 'keydown';
        event.preventDefault();
      }
    }
    window.addEventListener('keydown', track);
    window.addEventListener('keyup', track);
    return down;
  }

  arrowKeys = this.trackKeys([
    'ArrowLeft',
    'ArrowRight',
    'ArrowUp',
    'ArrowDown',
    'Enter',
  ]);

  runAnimation(frameFunc: any) {
    let lastTime: any = null;
    const frame = (time: number) => {
      if (lastTime != null) {
        let timeStep = Math.min(time - lastTime, 100) / 1000;
        if (frameFunc(timeStep) === false) return;
      }
      lastTime = time;
      this.loopId = requestAnimationFrame(frame);
    };
    this.loopId = requestAnimationFrame(frame);
  }

  runLevel(level: Level, Display: CanvasDisplay) {
    let display: CanvasDisplay = Display;
    let state: State = State.start(level);
    console.log(state);
    let ending = 2;
    return new Promise((resolve) => {
      this.runAnimation((time: number) => {
        state = state.update(time, this.arrowKeys);
        display.syncState(state);
        if (state.status === 'playing') {
          return true;
        } else if (ending > 0) {
          ending -= time;
          return true;
        } else {
          resolve(state.status);
          return false;
        }
      });
    });
  }

  async runGame(plans: string[], Display: CanvasDisplay) {
    for (let level = 0; level < plans.length; ) {
      let status = await this.runLevel(new Level(plans[level]), Display);
      if (status === 'won') level++;
    }
    console.log("You've won!");
  }

  results = [
    { name: 'Satisfied', count: 1043, color: 'lightblue' },
    { name: 'Neutral', count: 563, color: 'lightgreen' },
    { name: 'Unsatisfied', count: 510, color: 'pink' },
    { name: 'No comment', count: 175, color: 'silver' },
  ];
}
